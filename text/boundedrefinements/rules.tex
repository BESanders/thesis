\NV{Questions on the Abstract Refinement paper:}
\NV{1. WF-Abs-alpha: why we put alpha into the environment?}
\NV{2. We do we need the first two well-formedness rules?}
\newcommand\interp[1]{\ensuremath{[\! | #1 |\!]}}


\begin{figure}[!ht]
\judgementHead{Well-Formedness}{\isWellFormed{\Gamma}{\sigma}}

$$
\inference
  {}
  {\isWellFormed{\Gamma}{\true(\vref)}}
  [\wtTrue]
$$

$$
\inference
    {\isWellFormed{\Gamma}{\areft(\vref)} && 
     \hastype{\Gamma}{\rvapp{\rvar}{e} \ \vref}{\tbbool}
    }
    {\isWellFormed{\Gamma}{(\areft \wedge \rvapp{\rvar}{e})(\vref)}}
    [\wtRVApp]
$$

$$\inference
    {\hastype{\Gamma, \vref:b}{\reft}{\tbbool} \quad 
     \isWellFormed{\Gamma, \vref:b}{\areft(\vref)}
    }
    {\isWellFormed{\Gamma}{\tpref{b}{\areft}{\reft}}}
    [\wtBase]
$$

$$
\inference
    {
	\hastype{\Gamma}{\reft}{\tbbool} &&
    \isWellFormed{\Gamma}{\tau_x} &&
	\isWellFormed{\Gamma, x:\tau_x}{\tau}
    }
    {\isWellFormed{\Gamma}{\trfun{x}{\tau_x}{\tau}{\reft}}}
    [\wtFun]
$$


$$\begin{array}{ccc}
\inference
  {\isWellFormed{\Gamma, \rvar:\tau}{\sigma}}
  {\isWellFormed{\Gamma}{\tpabs{\rvar}{\tau}{\sigma}}}
  [\wtPred]
&
\quad
&
\inference
    {\isWellFormed{\Gamma}{\sigma}}
    {\isWellFormed{\Gamma}{\ttabs{\alpha}{\sigma}}}
    [\wtPoly]
\end{array}$$

\medskip \judgementHead{Subtyping}{\isSubType{\Gamma}{\sigma_1}{\sigma_2}}

$$
\inference
   {\text{SMT-Valid}(\inter{\Gamma} \land \inter{\areft_1\ \vref} \Rightarrow \inter{\reft_1} 
                 \Rightarrow \inter{\areft_2\ \vref} \land \inter{\reft_2})}
   {\isSubType{\Gamma}{\tpref{b}{\areft_1}{\reft_1}}{\tpref{b}{\areft_2}{\reft_2}}}
   [\tsubBase]
$$

$$
\inference
   {%\text{Valid}(\inter{\Gamma}\land \inter{e_1} \Rightarrow \inter{e_2}) \\
	\isSubType{\Gamma}{\tau_2}{\tau_1} &
	\isSubType{\Gamma, x_2:{\tau_2}}{\SUBST{\tau_1'}{x_1}{x_2}}{\tau_2'}	
   }
   {\isSubType{\Gamma}
	  {\trfun{x_1}{\tau_1}{\tau_1'}{\reft_1}}
	  {\trfun{x_2}{\tau_2}{\tau_2'}{\true}}
}[\tsubFun]
$$


$$
\inference
   {\isSubType{\Gamma, \rvar:\tau}{\sigma_1}{\sigma_2}}
   {\isSubType{\Gamma}{\tpabs{\rvar}{\tau}{\sigma_1}}{\tpabs{\rvar}{\tau}{\sigma_2}}}
   [\tsubPred]
$$
$$
\inference
   {\isSubType{\Gamma}{\sigma_1}{\sigma_2}}
   {\isSubType{\Gamma}{\ttabs{\alpha}{\sigma_1}}{\ttabs{\alpha}{\sigma_2}}}
   [\tsubPoly]
$$

\medskip \judgementHead{Type Checking}{$\hastype{\Gamma}{e}{\sigma}$}

$$
\inference
  {  \hastype{\Gamma}{e}{\sigma_2} && \isSubType{\Gamma}{\sigma_2}{\sigma_1} 
  && \isWellFormed{\Gamma}{\sigma_1}
  }
  {\hastype{\Gamma}{e}{\sigma_1}}
  [\tsub]
$$

$$
\inference
  {}
  {\hastype{\Gamma}{c}{\tc{c}}}
  [\tconst]
$$

$$
\inference
  {x: \tpref{b}{\areft}{\reft} \in \Gamma}
  {\hastype{\Gamma}{x}{\tpref{b}{\areft}{e \land \vref = x}}}
  [\tbase]
$$
$$
\inference
  {x:\tau \in \Gamma}
  {\hastype{\Gamma}{x}{\tau}} 
  [\tvariable]
$$

$$
\inference
   {\hastype{\Gamma, x:\tau_x}{e}{\tau} 
    && \isWellFormed{\Gamma}{\tau_x}
   }
   {\hastype{\Gamma}{\efunt{x}{\tau_x}{e}}{\tfun{x}{\tau_x}{\tau}}}
   [\tfunction]
$$
$$
\inference
   {\hastype{\Gamma}{e_1}{\tfun{x}{\tau_x}{\tau}} 
   &&  \hastype{\Gamma}{e_2}{\tau_x}
   }
   {\hastype{\Gamma}{\eapp{e_1}{e_2}}{\SUBST{\tau}{x}{e_2}}}
   [\tapp]
$$
$$
\inference
  {\hastype{\Gamma, \alpha}{e}{\sigma}}
  {\hastype{\Gamma}{\etabs{\alpha}{e}}{\ttabs{\alpha}{\sigma}}}
  [\tgen]
\qquad
\inference
  {\hastype{\Gamma}{e}{\ttabs{\alpha}{\sigma}} && 
   \isWellFormed{\Gamma}{\tau}
  }
  {\hastype{\Gamma}{\etapp{e}{\tau}}{\SUBST{\sigma}{\alpha}{\tau}}}
  [\tinst]
$$
$$
\inference
    {\hastype{\Gamma, \rvar:\tau}{e}{\sigma} &&
     \isWellFormed{\Gamma}{\tau} 
     % \tau \mbox{ is non-refined } 
     %\isWellFormed{\Gamma}{\tpabs{p}{\tau}{\pi}} && 
     %p \notin \fv{e}
    }
    {\hastype{\Gamma}{\epabs{\rvar}{\tau}{e}}{\tpabs{\rvar}{\tau}{\sigma}}}
    [\tpgen]
$$
$$
\inference
    {\hastype{\Gamma}{e}{\tpabs{\rvar}{\tau}{\sigma}} && 
     \hastype{\Gamma}{\efunbar{x:\tau_x}{\reft'}}{\tau}
    }
    {\hastype{\Gamma}
             {\epapp{e}{\efunbar{x:\tau_x}{\reft'}}}
             {\rpinst{\sigma}{\rvar}{\efunbar{x:\tau_x}{\reft'}}}
    }
    [\tpinst]
$$
\caption{\textbf{Static Semantics: Well-formedness, Subtyping and Type Checking}}
\label{fig:rules}
\end{figure}


\begin{figure}[!ht]
\judgementHead{Well-Formedness}{\isWellFormed{\Gamma}{\sigma}}

$$
\inference{
   \isWellFormed{\Gamma}{\Gamma_\constraint}             && 
	\isWellFormed{\Gamma, \Gamma_\constraint}{r_1} &&
	\isWellFormed{\Gamma, \Gamma_\constraint}{r_2} &&
	\isWellFormed{\Gamma}{\tau}
}{
	\isWellFormed{\Gamma}{\{\isSubType{\Gamma_\constraint}{r_1}{r_2}\} \carrow  \tau}
}[\wfBounded]
$$

$$
\inference{
}{
	\isWellFormed{\Gamma}{\emptyset}
}[\wfGammaEmpty]
$$
$$
\inference{
	\isWellFormed{\Gamma_1}{\sigma} && \isWellFormed{\Gamma_1, x\colon\sigma}{\Gamma_2}
}{
	\isWellFormed{\Gamma_1}{x\colon\sigma, \Gamma_2}
}[\wfGammaNonEmpty]
$$


\medskip \judgementHead{Subtyping}{\isSubType{\Gamma}{\sigma_1}{\sigma_2}}

$$
\inference{
    \isSubType{\Gamma_\constraint}{r_1}{r_2} && 
    \isSubType{\Gamma}{\tau_1}{\tau_2}
}{
   \isSubType{\Gamma}{\{\isSubType{\Gamma_\constraint}{r_1}{r_2}\} \carrow  \tau_1}{\tau_2}
}[\tsubPoly]
$$

\medskip \judgementHead{Type Checking}{$\hastype{\Gamma}{e}{\sigma}$}
$$
\inference{
	\text{fresh}\ x &&
	\hastype{\Gamma, x\colon\tref{\tbunit}{\interp{\isSubType{\Gamma_\constraint}{r_1}{r_2}}}}{e}{\tau}
}{
  \hastype{\Gamma}{e}{\{\isSubType{\Gamma_\constraint}{r_1}{r_2}\} \carrow  \tau}
}[\tsub]
$$
$$
\inference{
  \hastype{\Gamma}{e}{\{\isSubType{\Gamma_\constraint}{r_1}{r_2}\} \carrow  \tau}
  && \isSubType{\Gamma, \Gamma_\constraint}{r_1}{r_2}
}{
  \hastype{\Gamma}{e}{\tau}
}[\tsub]
$$
\caption{\textbf{Extensions In Reality}}
\label{fig:rules}
\end{figure}


\begin{figure}[!ht]
\judgementHead{Well-Formedness}{\isWellFormed{\Gamma}{\sigma}}

$$
\inference{
	\isWellFormed{\Gamma}{\constraint} &&
	\isWellFormed{\Gamma}{\tau}
}{
	\isWellFormed{\Gamma}{\tconstraint{\constraint}{\tau}}
}[\wfBounded]
$$

\medskip \judgementHead{Subtyping}{\isSubType{\Gamma}{\sigma_1}{\sigma_2}}

$$
\inference{
    \isSubType{\Gamma_\constraint}{r_1}{r_2} && 
    \isSubType{\Gamma}{\tau_1}{\tau_2}
}{
   \isSubType{\Gamma}
                    {\tconstraint{\isSubType{\Gamma_1}{r_{11}}{r_{12}}}{\tau_1}}
                    {\tconstraint{\isSubType{\Gamma_2}{r_{21}}{r_{22}}}{\tau_2}}
}[\tsubPoly]
$$

\medskip \judgementHead{Type Checking}{$\hastype{\Gamma}{e}{\sigma}$}
$$
\inference{
	\hastype{\Gamma}{e}{\tconstraint{\isSubType{\Gamma'}{r_1}{r_2}}{\tau}} &&
	\isSubType{\Gamma, \Gamma'}{r_1}{r_2}
}{
  \hastype{\Gamma}{e\ \econstantconstraint}{\tau}
}
$$
$$
\inference{
	\text{fresh}\ x &&
	\isWellFormed{\Gamma}{\phi} && \hastype{\Gamma, x\colon\tref{\tbunit}{\inter{\constraint}}}{e}{\tau}
}{
  \hastype{\Gamma}{(\econstraint{e})}{\tconstraint{\constraint}{\tau}}
}
$$
\caption{\textbf{Extensions In Theory}}
\label{fig:rules}
\end{figure}



\begin{figure}[!ht]
\judgementHead{Well-Formedness-Constraint}{\isWellFormed{\Gamma}{\constraint}}
$$
\inference{
	\isWellFormed{\Gamma}{\Gamma'} 
	&& \isWellFormed{\Gamma, \Gamma'}{r_1}
	&& \isWellFormed{\Gamma, \Gamma'}{r_2}
}{
	\isWellFormed{\Gamma}{(\isSubType{\Gamma'}{r_1}{r_2})}
}
$$

$$
\inference{
}{
	\isWellFormed{\Gamma}{\emptyset}
}% [\wfGammaEmpty]
\qquad
\inference{
	\isWellFormed{\Gamma_1}{\sigma} && \isWellFormed{\Gamma_1, x\colon\sigma}{\Gamma_2}
}{
	\isWellFormed{\Gamma_1}{x\colon\sigma, \Gamma_2}
}% [\wfGammaNonEmpty]
$$

\caption{\textbf{More Rules}}
\label{fig:rules}
\end{figure}

\begin{figure}
$$
\begin{array}{l}
\interp{\isSubType{\Gamma}{\tpref{b}{\areft_1}{\reft_1}}{\tpref{b}{\areft_2}{\reft_2}}} \\
  \qquad =\forall(dom(\Gamma), \vref) . \inter{\Gamma} \land \inter{\areft_1\ \vref} \Rightarrow \inter{\reft_1} 
                 \Rightarrow \inter{\areft_2\ \vref} \land \inter{\reft_2} 
\end{array}
$$
\label{fig:rules}
\end{figure}


\NV{make clear how forall is an expression}

\subsection{Translation}
Let $n$ be the the maximum number of constraints that appear in a type in the program. 
Then 





$$\begin{array}{rclcrcl}
\tx{\true\ \vref} & \defeq 
  & \true  
  & \quad \quad &

\tx{\tpabs{\rvar}{\tau}{\sigma}} & \defeq 
  & \tfun{\rvar}{\tx{\tau}}{\tx{\sigma}} \\

\tx{(\areft \land \rvapp{\rvar}{e})\ \vref} & \defeq 
  & \tx{\areft\ \vref} \land \eapp{\eapp{\rvar}{\overline{e}}}{\vref} 
  & \quad \quad &

\tx{\ttabs{\alpha}{\sigma}} & \defeq 
  & \ttabs{\alpha}{\tx{\sigma}} \\

\tx{\tpref{b}{\areft}{\reft}} & \defeq 
  & \tref{b}{\reft \land \tx{\areft\ \vref}} 
  & \quad \quad &

\tx{\tfun{x}{\tau_1}{\tau_2}} & \defeq 
  & \tfun{x}{\tx{\tau_1}}{\tx{\tau_2}} 
%\tx{\trfun{x}{\tau_1}{\tau_2}{\reft}} \defeq 
%  & \trfun{x}{\tx{\tau_1}}{\tx{\tau_2}}{\tx{\reft}} \\
\end{array}$$
Similarly, we translate \corelan terms $e$ to \conlan 
terms $\tx{e}$ by converting refinement abstraction and application 
to $\lambda$-abstraction and application
$$\begin{array}{rclcrcl}
\tx{x} & \defeq & x & \quad \quad \quad & \tx{c} & \defeq & c \\
\tx{\efunt{x}{\tau}{e}} & \defeq & \efunt{x}{\tx{\tau}}{\tx{e}} & \quad & \tx{\eapp{e_1}{e_2}} & \defeq & \eapp{\tx{e_1}}{\tx{e_2}} \\
\tx{\etabs{\alpha}{e}} & \defeq & \etabs{\alpha}{\tx{e}} & \quad & \tx{\etapp{e}{\tau}} & \defeq & \eapp{\tx{e}}{\tx{\tau}} \\
\tx{\epabs{\rvar}{\tau}{e}} &\defeq & \efunt{\rvar}{\tx{\tau}}{\tx{e}} & \quad & \tx{\epapp{e_1}{e_2}} &\defeq & \eapp{\tx{e_1}}{\tx{e_2}}
\end{array}$$







